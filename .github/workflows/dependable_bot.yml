name: Dependabot + Security Validation

on:
  pull_request:
    types: [opened, reopened, synchronize]
    paths:
      - '**/package.json'
      - '**/pom.xml'
      - '**/go.mod'
      - '**/requirements.txt'
      - '.github/workflows/**'
  schedule:
    - cron: '0 2 * * *'   # nightly or weekly run
  workflow_dispatch:

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up environment / install dependencies
        run: |
          npm ci

      - name: Install Playwright Browsers
        run: |
          npx playwright install --with-deps

      - name: Run tests
        run: |
          npm test

  zap_scan:
    needs: build_and_test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Start local server
        run: |
          npm start &

      - name: Wait for server ready
        run: |
          n=0
          until $(curl --output /dev/null --silent --head --fail http://127.0.0.1:3000); do
            n=$((n + 1))
            if [ $n -ge 30 ]; then
              echo "Server did not start in time"
              exit 1
            fi
            sleep 2
          done

      - name: Run OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'http://127.0.0.1:3000'
          docker_name: 'owasp/zap2docker-stable'
          allow_issue_writing: false

      - name: Stop server
        run: |
          kill $(lsof -t -i:3000) || true

      - name: Upload ZAP report
        uses: actions/upload-artifact@v3
        with:
          name: zap-report
          path: ./zap-report*

  auto_merge:
    needs: [build_and_test, zap_scan]
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.user.login == 'dependabot[bot]' &&
      github.repository == github.event.pull_request.base.repo.full_name
    steps:
      - name: Auto-merge Dependabot PR
        uses: pascalgn/automerge-action@v0.14.3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          merge_method: squash
